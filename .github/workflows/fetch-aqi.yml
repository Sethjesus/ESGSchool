name: Fetch AQI cache

on:
  schedule:
    - cron: "*/10 * * * *"   # 每 10 分鐘（UTC）
  workflow_dispatch: {}       # 允許手動執行

permissions:
  contents: write

concurrency:
  group: fetch-aqi
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq (JSON 處理工具)
        run: sudo apt-get update && sudo apt-get install -y jq

      # 小診斷：確認 Secret 有帶到（不會顯示金鑰內容）
      - name: Debug secrets presence
        env:
          HAS_KEY: ${{ secrets.MOENV_API_KEY != '' }}
        run: echo "MOENV_API_KEY present? $HAS_KEY"

      - name: Fetch MoENV AQI → normalize keys → aqi.json
        env:
          MOENV_API_KEY: ${{ secrets.MOENV_API_KEY }}
          DATASET: aqx_p_432
        run: |
          set -e
          URL="https://data.moenv.gov.tw/api/v2/${DATASET}?offset=0&limit=1000&api_key=${MOENV_API_KEY}"
          echo "GET $URL"
          # 1) 取原始 JSON
          curl -sS "$URL" -o raw.json
          # 2) 轉鍵名：全小寫、把 . 和 - 換成 _
          #    只處理 records 內每個 object 的鍵
          jq '{
                source: "'"$URL"'",
                generated_utc: (now | todateiso8601),
                count: (.records | length),
                records: (.records | map(
                  with_entries(.key |= ascii_downcase | .key |= gsub("\\\\."; "_") | .key |= gsub("-", "_"))
                ))
              }' raw.json > aqi.json
          rm -f raw.json
          echo "Wrote $(wc -c < aqi.json) bytes to aqi.json"

      # 如果你的 GitHub Pages 是 /docs 模式，取消註解以下兩行，並改前端讀取 docs/aqi.json
      # - name: Move cache to docs/ for Pages
      #   run: |
      #     mkdir -p docs
      #     mv -f aqi.json docs/aqi.json

      - name: Commit and push if changed
        run: |
          if [[ -n "$(git status --porcelain aqi.json docs/aqi.json 2>/dev/null)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add aqi.json docs/aqi.json 2>/dev/null || true
            git commit -m "chore(aqi): update cache $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "✅ aqi.json 無變更或尚未生成"
          fi
