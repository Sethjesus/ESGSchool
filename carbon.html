<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸŒ± ç¢³åŒ¯ï¼šå›ºç¢³åŸç†èˆ‡å…¬å¼ + å°å°é€ æ—å®¶</title>
  <style>
    /* ===== åŸºç¤æ¨£å¼ï¼ˆå»¶çºŒä½ çš„è¨­è¨ˆï¼‰ ===== */
    body{font-family:"Microsoft JhengHei",sans-serif; margin:0; background:#fdfdfd; color:#222; transition:background .3s, color .3s;}
    body.dark{background:#1e293b; color:#f1f5f9;}
    nav{background:#f4f4f4; padding:10px; display:flex; justify-content:space-between; align-items:center;}
    body.dark nav{background:#0f172a;}
    nav a{color:#333; text-decoration:none; margin-left:12px;}
    body.dark nav a{color:#f1f5f9;}
    nav .brand{font-weight:700; color:#1e90ff}
    main{max-width:1080px; margin:24px auto; padding:0 16px;}
    h1{margin:8px 0 16px; color:#2c3e50}
    h2{margin:28px 0 10px; color:#2c3e50}
    p{line-height:1.75}
    ul{line-height:1.7}

    /* Switch */
    .switch{margin-left:16px; position:relative; display:inline-block; width:44px; height:24px; vertical-align:middle;}
    .switch input{opacity:0; width:0; height:0;}
    .slider{position:absolute; cursor:pointer; inset:0; background:#ccc; transition:.4s; border-radius:24px;}
    .slider:before{position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.4s; border-radius:50%;}
    input:checked + .slider{background:#1e90ff;}
    input:checked + .slider:before{transform:translateX(20px);} 
    .switch-text{margin-left:8px; font-size:14px; color:#333; cursor:pointer; user-select:none; vertical-align:middle;}
    body.dark .switch-text{color:#f1f5f9;}

    /* Carousel */
    .carousel{position:relative; border-radius:12px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,.07);} 
    .carousel .stage{position:relative; width:100%; aspect-ratio:16/9; background:#111;}
    .carousel .slide{position:absolute; inset:0; display:none;}
    .carousel .slide.active{display:block;}
    .carousel img{width:100%; height:100%; object-fit:cover; transition:transform .35s ease;}
    .carousel:hover .slide.active img{transform:scale(1.02);} 
    .arrow{position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,.45); color:#fff; border:none; width:42px; height:42px; border-radius:50%; cursor:pointer; display:grid; place-items:center; font-size:18px;}
    .arrow:hover{background:rgba(0,0,0,.6);} .prev{left:10px} .next{right:10px}
    .dots{position:absolute; left:0; right:0; bottom:10px; display:flex; gap:8px; justify-content:center;}
    .dot{width:10px; height:10px; border-radius:50%; border:2px solid rgba(255,255,255,.9); background:rgba(255,255,255,.25); cursor:pointer;} .dot.active{background:#fff}
    .progress{position:absolute; left:0; right:0; bottom:0; height:4px; background:rgba(255,255,255,.18);} .progress .bar{height:100%; width:0%; background:linear-gradient(90deg,#5fb3ff,#1e90ff);} 
    .caption{position:absolute; left:12px; bottom:12px; background:rgba(0,0,0,.42); color:#fff; font-size:14px; padding:6px 10px; border-radius:8px; max-width:min(80%, 800px); line-height:1.5;}
    .controls{position:absolute; right:10px; bottom:10px; display:flex; gap:8px;} .btn{background:rgba(0,0,0,.45); color:#fff; border:none; border-radius:10px; padding:6px 10px; font-size:13px; cursor:pointer;} .btn:hover{background:rgba(0,0,0,.6);} 

    /* ===== å°éŠæˆ²ï¼šå°å°é€ æ—å®¶ï¼ˆåœ‹å°å‹å–„ï¼‰ ===== */
    .game{margin-top:36px; background:#f9fafb; border-radius:14px; padding:18px; box-shadow:0 8px 20px rgba(0,0,0,.06);} 
    body.dark .game{background:#0f172a;}
    .game h2{display:flex; align-items:center; gap:8px; margin:0 0 8px;}
    .game .desc{color:#475569; font-size:14px; margin-bottom:12px;}
    body.dark .game .desc{color:#94a3b8;}
    .status{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:8px 0 14px;}
    .chip{padding:8px 12px; border-radius:999px; background:#e2e8f0; font-size:14px;}
    body.dark .chip{background:#0b1220;}
    .chip b{font-size:15px;}
    .bar{height:14px; background:#e5e7eb; border-radius:999px; overflow:hidden; box-shadow:inset 0 0 0 1px rgba(0,0,0,.05);} 
    .bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#eab308,#ef4444);} 

    .actions{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:14px;}
    .card{background:#fff; border-radius:12px; padding:12px; display:flex; gap:10px; align-items:center; justify-content:space-between; box-shadow:0 2px 8px rgba(0,0,0,.05);} 
    body.dark .card{background:#0b1220;}
    .card .left{display:flex; gap:10px; align-items:center;}
    .card .emoji{font-size:24px;}
    .card .title{font-weight:700;}
    .card .note{font-size:12px; color:#64748b;}
    body.dark .card .note{color:#94a3b8;}
    .card button{border:none; padding:8px 12px; border-radius:10px; cursor:pointer; background:#1e90ff; color:#fff;}
    .card button:disabled{opacity:.6; cursor:not-allowed;}

    .row{display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px;}
    @media (min-width:900px){ .row{grid-template-columns:2fr 1fr;} }

    .panel{background:#fff; border-radius:12px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,.05);} 
    body.dark .panel{background:#0b1220;}
    .panel h3{margin:0 0 8px;}
    .tips li{margin:6px 0;}
    .msg{margin-top:10px; font-weight:800;}
    .ok{color:#16a34a;} .warn{color:#ef4444;}
    .controls{display:flex; gap:8px; margin-top:10px;}
    .controls button{border:none; padding:8px 12px; border-radius:10px; cursor:pointer;}
    .controls .primary{background:#111827; color:#fff;}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#e5e7eb; padding:2px 6px; border-radius:6px;}
    body.dark .kbd{background:#0b1220;}
      /* ===== Sticky åº•éƒ¨æ§åˆ¶åˆ— ===== */
    .sticky-controls{position:sticky; bottom:0; left:0; right:0; display:flex; gap:8px; padding:10px 12px; background:rgba(248,250,252,.88); backdrop-filter:saturate(180%) blur(10px); border-top:1px solid rgba(0,0,0,.08); border-bottom-left-radius:12px; border-bottom-right-radius:12px;}
    body.dark .sticky-controls{background:rgba(15,23,42,.85); border-top:1px solid rgba(255,255,255,.08);} 
    /* é¿å…è¢«åº•éƒ¨æ§åˆ¶åˆ—é®åˆ°å…§å®¹ */
    .game{ padding-bottom:72px; }
      /* ===== Sticky åº•éƒ¨æ§åˆ¶åˆ— ===== */
    .sticky-controls{position:sticky; bottom:0; left:0; right:0; display:flex; gap:8px; padding:10px 12px; background:rgba(248,250,252,.88); backdrop-filter:saturate(180%) blur(10px); border-top:1px solid rgba(0,0,0,.08); border-bottom-left-radius:12px; border-bottom-right-radius:12px;}
    body.dark .sticky-controls{background:rgba(15,23,42,.85); border-top:1px solid rgba(255,255,255,.08);} 
    .game{ padding-bottom:72px; position:relative; }

    /* ===== æ…¶ç¥å‹•ç•« & å‹³ç«  ===== */
    #confettiCanvas{position:absolute; inset:0; width:100%; height:100%; pointer-events:none;}
    .medal{position:absolute; top:18px; right:18px; display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; font-weight:700; background:rgba(255,255,255,.9); box-shadow:0 2px 10px rgba(0,0,0,.12);} 
    body.dark .medal{background:rgba(2,6,23,.9);} 
    .medal .tier{font-size:20px;} .medal .label{font-size:14px;}
  </style>
</head>
<body>
  <nav>
    <div class="brand">ğŸ“˜ UDM ESG æ°¸çºŒæ•™ç§‘æ›¸</div>
    <div>
      <a href="index.html">ğŸ  é¦–é </a>
      <a href="sunshine.html">ğŸŒ é™½å…‰</a>
      <a href="air.html">ğŸ’¨ ç©ºæ°£</a>
      <a href="water.html">ğŸ’§ æ°´</a>
      <a href="carbon.html">ğŸŒ± ç¢³åŒ¯</a>
      <label class="switch">
        <input type="checkbox" id="darkToggle" aria-label="åˆ‡æ›æ·±è‰²æ¨¡å¼">
        <span class="slider"></span>
      </label>
      <label class="switch-text" for="darkToggle">æ·±è‰²</label>
    </div>
  </nav>

  <main>
    <h1>ğŸŒ± ç¢³åŒ¯ï¼šå›ºç¢³åŸç†èˆ‡å…¬å¼</h1>

    <!-- ===== ç¢³åŒ¯ä»‹ç´¹è¼ªæ’­ ===== -->
    <section class="carousel" id="carbonCarousel" tabindex="0" aria-label="ç¢³åŒ¯ä»‹ç´¹è¼ªæ’­">
      <div class="stage">
        <div class="slide active"><img src="C1.png" alt="æ£®æ—ç¢³åŒ¯" data-caption="æ£®æ—æ˜¯é‡è¦ç¢³åŒ¯ï¼šé€éå…‰åˆä½œç”¨æŠŠ COâ‚‚ è®Šæˆç”Ÿç‰©é‡ã€‚"></div>
        <div class="slide"><img src="C2.png" alt="è‰åœ°ç¢³åŒ¯" data-caption="è‰åœ°èˆ‡æ¿•åœ°æŠŠç¢³é•·æœŸå„²å­˜åœ¨æ¤ç‰©é«”èˆ‡åœŸå£¤ä¸­ã€‚"></div>
        <div class="slide"><img src="C3.png" alt="æµ·æ´‹ç¢³åŒ¯" data-caption="æµ·æ´‹æµ®æ¸¸æ¤ç‰©æ¯å¹´å¸æ”¶å…¨çƒç´„å››åˆ†ä¹‹ä¸€ COâ‚‚ã€‚"></div>
        <div class="slide"><img src="C4.png" alt="æ ¡åœ’ç¢³åŒ¯" data-caption="æ ¡åœ’æ¨¹æœ¨èª¿æŸ¥å¯ç”¨ DBH èˆ‡æ¨¹é«˜ä¼°ç®—ç¢³åŒ¯ã€‚"></div>
        <div class="slide"><img src="C5.png" alt="æ¨¹é½¡ç¢³åŒ¯" data-caption="æ¨¹é½¡ä¸åŒï¼Œå¹´å›ºç¢³é‡ä¹Ÿä¸åŒï¼Œæˆé•·æœ€å¿«æ™‚å¸æ”¶æœ€å¤šã€‚"></div>
        <div class="slide"><img src="C6.png" alt="æ°¸çºŒç¶“ç‡Ÿ" data-caption="æ°¸çºŒç¶“ç‡Ÿï¼šä¿è‚²ã€ç”Ÿç”¢ã€æ•™è‚²ä¸‰åˆä¸€ã€‚"></div>
        <div class="slide"><img src="C7.png" alt="è³‡æ–™ç¢³åŒ¯" data-caption="ä»¥è³‡æ–™é©…å‹•çš„ç¢³åŒ¯ç›¤é»èˆ‡æ•™å­¸æ´»å‹•ã€‚"></div>
        <button class="arrow prev" aria-label="ä¸Šä¸€å¼µ">â€¹</button>
        <button class="arrow next" aria-label="ä¸‹ä¸€å¼µ">â€º</button>
        <div class="dots" aria-hidden="true"></div>
        <div class="controls"><button class="btn" id="togglePlay">â¸ æš«åœ</button></div>
        <div class="caption" id="caption">æ£®æ—æ˜¯é‡è¦ç¢³åŒ¯ï¼šé€éå…‰åˆä½œç”¨æŠŠ COâ‚‚ è®Šæˆç”Ÿç‰©é‡ã€‚</div>
        <div class="progress"><div class="bar" id="progressBar"></div></div>
      </div>
    </section>

    <h2>ğŸ“˜ ä»€éº¼æ˜¯ç¢³åŒ¯ï¼Ÿ</h2>
    <p>ç¢³åŒ¯ï¼ˆCarbon Sinkï¼‰æ˜¯èƒ½å¤ å¸æ”¶ä¸¦å„²å­˜äºŒæ°§åŒ–ç¢³ï¼ˆCOâ‚‚ï¼‰çš„è‡ªç„¶æˆ–äººå·¥ç³»çµ±ï¼Œæ˜¯å°æŠ—æ°£å€™è®Šé·çš„é‡è¦åŠ›é‡ã€‚</p>
    <ul>
      <li>ğŸŒ³ æ£®æ—ï¼šé€éå…‰åˆä½œç”¨å¸æ”¶ COâ‚‚</li>
      <li>ğŸŒ¿ è‰åœ°èˆ‡æ¿•åœ°ï¼šå„²å­˜ç¢³æ–¼æ¤ç‰©é«”èˆ‡åœŸå£¤</li>
      <li>ğŸŒŠ æµ·æ´‹ï¼šæµ·è—»èˆ‡æµ®æ¸¸æ¤ç‰©ä¹Ÿæ˜¯é‡è¦ç¢³åŒ¯</li>
    </ul>

    <h2>ğŸ“ ç°¡åŒ–è¨ˆç®—ï¼š</h2>
    <ul>
      <li><strong>ç”Ÿç‰©é‡ï¼š</strong> Biomass = 0.15 Ã— DBH<sup>2.27</sup></li>
      <li><strong>ç¢³å«é‡ï¼š</strong> Carbon = Biomass Ã— 0.5</li>
      <li><strong>COâ‚‚ å›ºå®šé‡ï¼š</strong> COâ‚‚ = Carbon Ã— 3.67</li>
    </ul>

    <!-- ===== å°éŠæˆ²ï¼šå°å°é€ æ—å®¶ ===== -->
    <section class="game" id="game">
      <h2>ğŸ® å°å°é€ æ—å®¶ï¼šä¸€èµ·æŠŠ COâ‚‚ æ”¶é€²æ¨¹å’Œæµ·è£¡ï¼</h2>
      <div class="desc">ç›®æ¨™ï¼šåœ¨ 10 æ­¥å…§ï¼Œè®“ã€Œå·²å›ºå®š COâ‚‚ã€é”åˆ° <b id="goal"></b>ã€‚æ¯åšä¸€å€‹è¡Œå‹•ç®— 1 æ­¥ã€‚æç¤ºæœƒå‘Šè¨´ä½ ä¸‹ä¸€æ­¥è©²åšä»€éº¼æ›´æœ‰æ•ˆï¼</div>

      <div class="status">
        <span class="chip">å·²å›ºå®š COâ‚‚ï¼š<b id="score">0 g</b></span>
        <span class="chip">å‰©é¤˜æ­¥æ•¸ï¼š<b id="steps">10</b></span>
        <span class="chip">ä¿è­·ç‹€æ…‹ï¼š<b id="shield">ç„¡</b></span>
      </div>
      <div class="bar" aria-hidden="true"><i id="barFill"></i></div>

      <div class="row">
        <div>
          <div class="actions" id="actions"></div>
          <div class="msg" id="msg"></div>
        </div>
        <aside class="panel">
          <h3>ğŸ§  çŸ¥è­˜å°å¡</h3>
          <ul class="tips" id="tips">
            <li>ğŸŒ³ æ¨¹æœ¨é•·å¤§æœƒå¸æ›´å¤š COâ‚‚ï¼Œå¹¼æ¨¹è¦ä¿è­·å¥½ï¼</li>
            <li>ğŸŒ¿ ä¸ç„šç‡’è½è‘‰ï¼Œè®“å®ƒè®ŠæˆåœŸå£¤çš„é¤Šåˆ†ã€‚</li>
            <li>ğŸŒŠ æµ·è—»å’Œæµ®æ¸¸æ¤ç‰©ä¹Ÿå¾ˆæœƒã€Œåƒã€COâ‚‚ã€‚</li>
            <li>ğŸªµ ç ä¼å¾Œçš„æœ¨æå¦‚æœè¢«ç‡ƒç‡’ï¼ŒæœƒæŠŠç¢³åˆæ”¾å›ç©ºæ°£ã€‚</li>
          </ul>
        </aside>
      </div>

      <!-- æ…¶ç¥å€åŸŸï¼šå‹³ç«  + ç´™èŠ± -->
      <canvas id="confettiCanvas" aria-hidden="true"></canvas>
      <div id="medal" class="medal" hidden>
        <span class="tier" id="medalTier">ğŸ¥‡</span>
        <span class="label" id="medalLabel">é‡‘ç‰Œé€ æ—å®¶ï¼</span>
      </div>

      <!-- Sticky æ§åˆ¶åˆ—ï¼šå›ºå®šåœ¨éŠæˆ²å€å¡Šåº•éƒ¨ -->
      <div class="sticky-controls" role="toolbar" aria-label="éŠæˆ²æ§åˆ¶åˆ—">
        <button class="primary" id="nextRound">ğŸ” é‡æ–°é–‹å§‹</button>
        <button id="teacherMode">ğŸ“ è€å¸«æ¨¡å¼ï¼šé¡¯ç¤ºçŸ¥è­˜å°å¡</button>
      </div>
    </section>
  </main>

  <script>
    // ===== æ·±è‰²æ¨¡å¼ =====
    const darkToggle = document.getElementById("darkToggle");
    darkToggle?.addEventListener("change", ()=> document.body.classList.toggle("dark", darkToggle.checked));

    // ===== è¼ªæ’­ =====
    (function(){
      const root = document.getElementById('carbonCarousel');
      if (!root) return;
      const slides = Array.from(root.querySelectorAll('.slide'));
      const prevBtn = root.querySelector('.prev');
      const nextBtn = root.querySelector('.next');
      const dotsWrap = root.querySelector('.dots');
      const progressBar = document.getElementById('progressBar');
      const caption = document.getElementById('caption');
      const togglePlayBtn = document.getElementById('togglePlay');

      const AUTOPLAY_MS = 4000; const DRAG_THRESHOLD = 40;
      let i = 0, timer = null, playing = true, startedAt=0;

      slides.forEach((_, idx)=>{ const d=document.createElement('div'); d.className='dot'+(idx===0?' active':''); d.addEventListener('click', ()=>{stop();go(idx);play();}); dotsWrap.appendChild(d); });
      const dots=Array.from(dotsWrap.children);

      function setCaption(idx){ const img=slides[idx].querySelector('img'); caption.textContent=img?.dataset?.caption||img?.alt||''; }
      function go(n){ slides[i].classList.remove('active'); dots[i].classList.remove('active'); i=(n+slides.length)%slides.length; slides[i].classList.add('active'); dots[i].classList.add('active'); setCaption(i); resetProgress(); }
      function next(){go(i+1);} function prev(){go(i-1);} function resetProgress(){startedAt=performance.now(); progressBar.style.width='0%';}
      function tick(){ if(!playing)return; const elapsed=performance.now()-startedAt; const p=Math.min(1,elapsed/AUTOPLAY_MS); progressBar.style.width=(p*100).toFixed(1)+'%'; if(p>=1) next(); timer=requestAnimationFrame(tick); }
      function play(){ if(playing)return; playing=true; togglePlayBtn.textContent='â¸ æš«åœ'; resetProgress(); timer=requestAnimationFrame(tick);} 
      function stop(){ playing=false; togglePlayBtn.textContent='â–¶ï¸ æ’­æ”¾'; cancelAnimationFrame(timer);} 

      togglePlayBtn.addEventListener('click',()=>playing?stop():play());
      nextBtn.addEventListener('click',()=>{stop();next();play();}); prevBtn.addEventListener('click',()=>{stop();prev();play();});
      root.addEventListener('mouseenter',stop); root.addEventListener('mouseleave',()=>{if(!playing)play();});
      document.addEventListener('visibilitychange',()=>{document.hidden?stop():play();});
      root.addEventListener('keydown',e=>{ if(e.key==='ArrowRight'){stop();next();play();} if(e.key==='ArrowLeft'){stop();prev();play();} if(e.key===' '){e.preventDefault(); playing?stop():play();} });
      let startX=null,dragging=false; const stage=root.querySelector('.stage');
      const onPointerDown=e=>{dragging=true;startX=e.clientX??e.touches?.[0]?.clientX;stop();}
      const onPointerUp=e=>{ if(!dragging)return; const endX=e.clientX??e.changedTouches?.[0]?.clientX; const dx=endX-startX; dragging=false; if(Math.abs(dx)>DRAG_THRESHOLD){dx<0?next():prev();} play(); }
      stage.addEventListener('mousedown',onPointerDown); window.addEventListener('mouseup',onPointerUp); stage.addEventListener('touchstart',onPointerDown,{passive:true}); stage.addEventListener('touchend',onPointerUp);
      setCaption(0); resetProgress(); timer=requestAnimationFrame(tick);
    })();

    // ===== å°éŠæˆ²ï¼šå°å°é€ æ—å®¶ =====
    (function(){
      const $=(q)=>document.querySelector(q);
      const actionsEl = $('#actions');
      const scoreEl = $('#score');
      const stepsEl = $('#steps');
      const shieldEl = $('#shield');
      const barFillEl = $('#barFill');
      const goalEl = $('#goal');
      const msgEl = $('#msg');
      const nextBtn = $('#nextRound');
      const teacherBtn = $('#teacherMode');
      const confettiCanvas = document.getElementById('confettiCanvas');
      const medalEl = document.getElementById('medal');
      const medalTierEl = document.getElementById('medalTier');
      const medalLabelEl = document.getElementById('medalLabel');

      // ç›®æ¨™ï¼ˆg CO2ï¼‰ä»‹æ–¼ 1200~2000
      let goal = 1500 + Math.floor(Math.random()*500);
      let score = 0;   // å·²å›ºå®š CO2ï¼ˆgï¼‰
      let steps = 10;  // è¡Œå‹•æ¬¡æ•¸
      let shield = 0;  // ä¿è­·é»æ•¸
      let teacher = false; // é¡¯ç¤ºçŸ¥è­˜å°å¡

      goalEl.textContent = goal + ' g';
      updateStatus();

      // è¡Œå‹•æ¸…å–®
      const ACTION_BANK = [
        { key:'tree',   title:'ç¨®ä¸€æ£µå°æ¨¹', emoji:'ğŸŒ³', gain:[350, 550], tip:'å¹¼æ¨¹è¦å®šæœŸæ¾†æ°´èˆ‡è­·æœ¨ï¼' },
        { key:'water',  title:'æ¾†æ°´è­·æ¨¹',   emoji:'ğŸ’§', gain:[120, 220], tip:'ä¹¾æ—±æ™‚å¤šæ¾†æ°´ï¼Œæ¨¹æ›´å¥åº·ã€‚' },
        { key:'fence',  title:'åœèµ·ä¿è­·ç¶²', emoji:'ğŸ§±', gain:[0, 0],    shield:2, tip:'å¯æŠµæ“‹ 2 æ¬¡é¢¨å®³æˆ–èŸ²å®³ã€‚' },
        { key:'sea',    title:'ç¨®æµ·è—»/æµ·è‰',emoji:'ğŸª¸', gain:[250, 450], tip:'æµ·è—»ä¹Ÿæœƒå¸ COâ‚‚ï¼Œæ˜¯æµ·æ´‹ç¢³åŒ¯ã€‚' },
        { key:'leaves', title:'è½è‘‰åšå †è‚¥', emoji:'ğŸ‚', gain:[150, 250], tip:'ä¸è¦ç„šç‡’ï¼è®“è½è‘‰è®Šè‚¥æ²ƒçš„åœŸã€‚' },
        { key:'clean',  title:'æ·¨å±±/æ’¿æµ·å»¢', emoji:'ğŸ§¹', gain:[80, 160],  tip:'è®“æ¨¹å’Œæµ·æ›´å¥åº·ã€å¸æ›´å¤šç¢³ã€‚' }
      ];

      // ====== éŸ³æ•ˆï¼ˆWebAudioï¼Œç„¡éœ€æª”æ¡ˆï¼‰ ======
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      let actx = null; function getCtx(){ return actx||(actx=new AudioCtx()); }
      function beep(freq=660, dur=0.08, type='sine', vol=0.05){
        try{
          const ctx=getCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
          o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(ctx.destination);
          const t=ctx.currentTime; o.start(t); o.stop(t+dur);
        }catch(e){}
      }
      function successJingle(){ setTimeout(()=>beep(880,0.1,'triangle',0.06),0); setTimeout(()=>beep(1175,0.12,'triangle',0.06),110); setTimeout(()=>beep(1568,0.14,'triangle',0.06),230); }

      // ====== ç´™èŠ±ï¼ˆç°¡æ˜“ç²’å­å‹•ç•«ï¼‰ ======
      const confetti = (function(){
        const ctx = confettiCanvas.getContext('2d');
        let W,H,particles=[],running=false,startT=0;
        function resize(){ W=confettiCanvas.width=confettiCanvas.clientWidth; H=confettiCanvas.height=confettiCanvas.clientHeight; }
        window.addEventListener('resize', resize, {passive:true}); resize();
        function spawn(n=120){
          particles=[]; for(let i=0;i<n;i++){
            particles.push({
              x: Math.random()*W,
              y: -10-Math.random()*H*0.3,
              r: 2+Math.random()*4,
              vx: -1+Math.random()*2,
              vy: 2+Math.random()*3,
              a: Math.random()*Math.PI*2
            });
          }
        }
        function draw(){ ctx.clearRect(0,0,W,H); particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.a+=0.05; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle = `hsl(${(p.x/W)*360},90%,60%)`; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore(); }); }
        function step(ts){ if(!running) return; if(!startT) startT=ts; draw(); if(ts-startT<3500) requestAnimationFrame(step); else{ running=false; ctx.clearRect(0,0,W,H);} }
        return { fire(){ spawn(); running=true; startT=0; requestAnimationFrame(step); } };
      })();

      function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
      function pickGain(a){ return randInt(a.gain[0], a.gain[1]); }

      function renderActions(){
        actionsEl.innerHTML = '';
        ACTION_BANK.forEach((a)=>{
          const card = document.createElement('div'); card.className='card';
          const left = document.createElement('div'); left.className='left';
          left.innerHTML = `<span class="emoji" aria-hidden="true">${a.emoji}</span><div><div class="title">${a.title}</div><div class="note">${a.gain[0]}~${a.gain[1]} g COâ‚‚${a.shield?`ï¼›ä¿è­·+${a.shield}`:''}</div></div>`;
          const btn = document.createElement('button'); btn.textContent='åŸ·è¡Œ'; btn.addEventListener('click',()=>doAction(a));
          card.appendChild(left); card.appendChild(btn); actionsEl.appendChild(card);
        });
      }

      function doAction(a){
        if(steps<=0){ toast('å·²æ²’æœ‰æ­¥æ•¸ï¼Œè«‹é‡æ–°é–‹å§‹ã€‚'); return; }
        steps--; beep(520,0.05,'sine',0.04);
        let g = pickGain(a);
        if(a.shield){ shield += a.shield; g = 0; }
        score += g;

        // 20% æ©Ÿç‡è§¸ç™¼éš¨æ©Ÿäº‹ä»¶
        if(Math.random() < 0.2){
          const bads=[{t:'ğŸŒªï¸ å°é¢±é¢¨ä¾†è¥²',d:180},{t:'ğŸ› èŸ²å®³å‡ºç¾',d:120},{t:'ğŸ¥µ ç†±æµªä¹¾æ—±',d:150}];
          const b = bads[randInt(0,bads.length-1)];
          if(shield>0){ shield--; toast(`${b.t} è¢«ä¿è­·ç¶²æ“‹ä½äº†ï¼ä¿è­·-1`); }
          else{ score = Math.max(0, score - b.d); toast(`${b.t}ï¼šæå¤± ${b.d} g`); }
        }

        updateStatus();
        checkEnd();
        smartHint(a);
      }

      function smartHint(lastAction){
        if(shield===0 && Math.random()<0.5){ info('æç¤ºï¼šè©¦è©¦ã€ŒğŸ§± åœèµ·ä¿è­·ç¶²ã€ï¼Œå¯æŠµæ“‹ 2 æ¬¡ç½å®³ã€‚'); return; }
        const best = ['tree','sea'];
        if(!best.includes(lastAction.key)){ info('æç¤ºï¼šæƒ³å¿«é€Ÿé”æ¨™ï¼Œå¯ä»¥å¤šç¨®å¹¾æ£µæ¨¹æˆ–æµ·è—»ï¼'); }
      }

      function updateStatus(){
        scoreEl.textContent = `${score} g`;
        stepsEl.textContent = steps;
        shieldEl.textContent = shield>0 ? `${shield} æ¬¡` : 'ç„¡';
        const pct = Math.min(1, score/goal);
        barFillEl.style.width = (pct*100).toFixed(1)+'%';
      }

      function awardMedal(){
        // ä¾å‰©é¤˜æ­¥æ•¸é ’ç™¼ï¼šâ‰¥6 é‡‘ã€â‰¥3 éŠ€ã€å…¶ä»– éŠ…
        const left = steps; let tier='gold', icon='ğŸ¥‡', text='é‡‘ç‰Œé€ æ—å®¶ï¼';
        if(left>=6){ tier='gold'; icon='ğŸ¥‡'; text='é‡‘ç‰Œé€ æ—å®¶ï¼'; }
        else if(left>=3){ tier='silver'; icon='ğŸ¥ˆ'; text='éŠ€ç‰Œé€ æ—å®¶ï¼'; }
        else { tier='bronze'; icon='ğŸ¥‰'; text='éŠ…ç‰Œé€ æ—å®¶ï¼'; }
        medalTierEl.textContent = icon; medalLabelEl.textContent = text; medalEl.hidden=false;
        successJingle(); confetti.fire();
      }

      function checkEnd(){
        if(score>=goal){ msgEl.innerHTML = '<span class="ok">ğŸ‰ å¤ªæ£’äº†ï¼ä½ æˆåŠŸæŠŠ COâ‚‚ æ”¶èµ·ä¾†äº†ï¼</span>'; disableAll(true); awardMedal(); }
        else if(steps===0){ msgEl.innerHTML = '<span class="warn">ğŸ•‘ æ­¥æ•¸ç”¨å®Œäº†ï¼Œå†è©¦ä¸€æ¬¡å§ï¼</span>'; disableAll(true); }
      }

      function disableAll(disabled){ actionsEl.querySelectorAll('button').forEach(b=>b.disabled=disabled); }

      function toast(t){ msgEl.textContent=t; }
      function info(t){ msgEl.textContent=t; }

      function reset(){
        goal = 1500 + Math.floor(Math.random()*500);
        score = 0; steps = 10; shield = 0; teacher = false;
        goalEl.textContent = goal + ' g';
        msgEl.textContent = '';
        medalEl.hidden=true; // éš±è—å‹³ç« 
        renderActions(); updateStatus();
        document.getElementById('tips').style.display='block';
      }

      nextBtn.addEventListener('click', reset);
      teacherBtn.addEventListener('click', ()=>{
        teacher = !teacher; document.getElementById('tips').style.display = teacher ? 'block' : 'none';
      });

      // å•Ÿå‹•
      renderActions();
    })();
  </script>
</body>
</html>
