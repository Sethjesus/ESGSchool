<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>台北市空氣品質｜AQI / PM2.5 / PM10 / NO₂ / O₃ / SO₂ / CO</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  body{font-family:"Microsoft JhengHei",system-ui,sans-serif;background:#f7f9fb}
  .card{border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .muted{color:#6c757d}
  .pill{background:#e9f2ff;color:#0d6efd;padding:.25rem .6rem;border-radius:999px;font-weight:600}
  .footer{color:#6c757d;font-size:.85rem}
</style>
</head>
<body class="p-3 p-md-4">
<main class="container">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">台北市空氣品質儀表板</h3>
    <span class="pill">GitHub Pages / 前端單檔</span>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <div class="fw-semibold mb-2">控制面板</div>

        <label class="form-label mb-1">測項</label>
        <select id="metric" class="form-select mb-3">
          <option value="aqi">AQI</option>
          <option value="pm2_5">PM2.5 (μg/m³)</option>
          <option value="pm10">PM10 (μg/m³)</option>
          <option value="no2">NO₂ (ppb)</option>
          <option value="o3">O₃ (ppb)</option>
          <option value="so2">SO₂ (ppb)</option>
          <option value="co">CO (ppm)</option>
        </select>

        <label class="form-label mb-1">測站</label>
        <select id="site" class="form-select mb-3"></select>

        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
          <label class="form-check-label" for="autoRefresh">每 10 分鐘自動更新</label>
        </div>

        <div class="d-flex gap-2">
          <button id="editKey" class="btn btn-outline-secondary btn-sm">設定 / 更換 API Key</button>
          <button id="refreshNow" class="btn btn-primary btn-sm">立即更新</button>
        </div>

        <hr>
        <div class="small muted" id="lastUpdate">最後更新：—</div>
        <div class="small muted" id="publishTime">發布時間：—</div>
        <hr>
        <div class="footer">
          資料源：環境部資料開放平台（僅篩選台北市測站）。<br>
          金鑰僅存於你的瀏覽器 <code>localStorage</code>，不會上傳到 GitHub。
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card p-3 mb-3">
        <div class="fw-semibold mb-2">目前值（台北各測站）</div>
        <canvas id="barChart" height="150"></canvas>
      </div>
      <div class="card p-3">
        <div class="fw-semibold mb-1">單站短期趨勢（以本頁多次輪詢暫存）</div>
        <div class="muted mb-2">提示：MoENV 即時 API 多為最新一筆資料，此處以本頁歷次抓取建立短期趨勢。</div>
        <canvas id="lineChart" height="130"></canvas>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== 設定區 ===== */
const API_AQI = "https://data.moenv.gov.tw/api/v2/aqx_p_432"; // AQI/即時空品資料集
const STORAGE_KEY = "moenv_api_key";
const DEFAULT_SITES = ["中山","大同","大直","士林","內湖","松山","南港","萬華","古亭","景美","陽明","文山","大安"]; // 你可增刪
const FETCH_PARAMS = { offset: 0, limit: 1000 }; // 抓寬一點
const TREND_MAX = 20; // 每站每測項最多保留 20 筆
const TREND = {}; // { site: { metric: [{t:ms, v:number}, ...] } }

/* ===== DOM ===== */
const metricEl = document.getElementById("metric");
const siteEl   = document.getElementById("site");
const autoEl   = document.getElementById("autoRefresh");
const lastEl   = document.getElementById("lastUpdate");
const pubEl    = document.getElementById("publishTime");
const editKey  = document.getElementById("editKey");
const refreshBtn = document.getElementById("refreshNow");

/* ===== Chart.js ===== */
const barChart = new Chart(document.getElementById("barChart"), {
  type: "bar",
  data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
  options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
});
const lineChart = new Chart(document.getElementById("lineChart"), {
  type: "line",
  data: { labels: [], datasets: [{ data: [], tension: .3, fill: false }] },
  options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
});

/* ===== 小工具 ===== */
function getKey() {
  let key = localStorage.getItem(STORAGE_KEY);
  if (!key) {
    key = prompt("請輸入 MoENV API Key：");
    if (key) localStorage.setItem(STORAGE_KEY, key.trim());
  }
  return key;
}
function setKey() {
  const k = prompt("輸入新的 MoENV API Key：", localStorage.getItem(STORAGE_KEY) || "");
  if (k !== null) localStorage.setItem(STORAGE_KEY, k.trim());
}
function aqiColor(v){
  if (v==null || isNaN(v)) return "#bdbdbd";
  if (v<=50) return "#2ecc71";
  if (v<=100) return "#f1c40f";
  if (v<=150) return "#e67e22";
  if (v<=200) return "#e74c3c";
  if (v<=300) return "#8e44ad";
  return "#7f1d1d";
}
const mono = () => "#3498db";
const toNum = x => (x==null?null:(+String(x).trim()));

/* ===== 取數據 ===== */
async function fetchAQI() {
  const key = getKey();
  if (!key) throw new Error("尚未設定 API Key");
  const url = new URL(API_AQI);
  Object.entries({ ...FETCH_PARAMS, api_key: key }).forEach(([k,v]) => url.searchParams.set(k,v));
  const resp = await fetch(url, { cache: "no-store" });
  if (!resp.ok) throw new Error("HTTP "+resp.status);
  const js = await resp.json();
  return js.records || [];
}

function initSites(records) {
  if (siteEl.options.length) return; // 已經有就不重建
  const names = [...new Set(
    records.map(r => r.sitename).filter(n => DEFAULT_SITES.includes(n))
  )].sort();
  siteEl.innerHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");
}

function pushTrend(site, metric, value) {
  TREND[site] = TREND[site] || {};
  TREND[site][metric] = TREND[site][metric] || [];
  const arr = TREND[site][metric];
  arr.push({ t: Date.now(), v: value });
  if (arr.length > TREND_MAX) arr.shift();
}

function drawBar(rows, metric) {
  const labels = rows.map(r => r.sitename);
  const vals   = rows.map(r => toNum(r[metric]));
  const colors = metric === "aqi" ? vals.map(aqiColor) : vals.map(mono);
  barChart.data.labels = labels;
  barChart.data.datasets[0].data = vals;
  barChart.data.datasets[0].backgroundColor = colors;
  barChart.update();
}

function drawLine(site, metric) {
  const series = (TREND[site] && TREND[site][metric]) || [];
  lineChart.data.labels = series.map(p => new Date(p.t).toLocaleTimeString());
  lineChart.data.datasets[0].data = series.map(p => p.v);
  lineChart.update();
}

/* ===== 主流程 ===== */
async function refresh() {
  try {
    const metric = metricEl.value;
    const data = await fetchAQI();

    // 初始化站點清單
    initSites(data);
    const wantedSites = new Set(DEFAULT_SITES);
    const tpRows = data.filter(r => wantedSites.has(r.sitename));

    // 左圖（全部站）
    drawBar(tpRows, metric);

    // 右圖（單站趨勢）
    const site = siteEl.value || tpRows[0]?.sitename;
    const row  = tpRows.find(r => r.sitename === site);
    if (row) {
      pushTrend(site, metric, toNum(row[metric]));
      pubEl.textContent = "發布時間：" + (row.publishtime || "—");
      drawLine(site, metric);
    }

    lastEl.textContent = "最後更新：" + new Date().toLocaleString();
  } catch (e) {
    console.error(e);
    lastEl.textContent = "最後更新：失敗（詳見 console）";
    if (String(e).includes("API Key")) alert("請先設定 API Key。");
  }
}

/* ===== 事件 ===== */
metricEl.addEventListener("change", refresh);
siteEl.addEventListener("change", refresh);
editKey.addEventListener("click", () => { setKey(); refresh(); });
refreshBtn.addEventListener("click", refresh);

/* 啟動輪詢 */
(async function tick(){
  await refresh();
  setInterval(() => { if (autoEl.checked) refresh(); }, 10*60*1000);
})();
</script>
</body>
</html>
